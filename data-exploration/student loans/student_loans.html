<html>
<head>
	<meta charset='utf-8' />
	<title>Student Loans</title>
	<script src="../lib/d3.v5.min.js"></script>
	<script src="../lib/topojson.v2.min.js"></script>
	<script src="../lib/d3-scale-chromatic.v1.min.js"></script>
	<script src="../lib/d3-simple-slider.min.js"></script>
	<script src="../lib/d3-tip.min.js"></script>
	<style>
	.states {
  stroke: #000;
  stroke-linejoin: round;
}
		
		.tip {
			background-color: aliceblue;
			padding: 1px;
			border-radius: 5px;
		}
		
	</style>
</head>
<body>
<script>


	
	var margin = {top: 50, right: 100, bottom: 50, left: 75};
	var width = 1024 - margin.left - margin.right,
    height = 700 - margin.top - margin.bottom;
	
	
	
	var projection = d3.geoAlbers()
    .center([0, 36])
    .rotate([96, 0])
    .parallels([45.5,29.5])
    .scale(750)
    .translate([width/2,height/2]);
	
		var path = d3.geoPath().projection(projection);
	
	var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
	.attr("class","quakeMap")
 	.append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
	
	var eqMap = {};
	
	var rowConvert = function(d) {
		dNew = {};
		for(var x in d) {
			var val = d[x].trim();
			if(x.trim()!="state")
				val = parseInt(val);
			dNew[x.trim()] = val;
		}
		eqMap[dNew.state] = dNew;
		return dNew;
	}
	
	var stateMap = {}
	var stateMapper = function(d) {
		stateMap[d.stname] = d.stusps;
		return d;
	}

	var promises = [d3.json("states-10m.json"),d3.csv('student_loans.csv',rowConvert),d3.csv('state_fips.csv',stateMapper)];
	
	Promise.all(promises).then(function([us,loans,states]) {
		console.log(loans);
		console.log(us);
		console.log(states);
		

			
			var buckets = 6;
		
		loans = loans.filter(d=>d.state!="DC");
		
		var scaleLoans = d3.scaleLog()
						.domain(d3.extent(loans,d=>d["Q4_2019"])).rangeRound([0,buckets])
		
		var hues = d3.schemeBlues[buckets];

		var m = topojson.feature(us,us.objects.states).features;
		m = m.filter(d=>eqMap[stateMap[d.properties.name]]!=null);
		console.log(m);
			

							var renderTip = function(d) {
				d = eqMap[stateMap[d.properties.name]];
		return `State: ${d.state}<br/>Stu. Debt pp: $${d['Q4_2019']}`;
	}
	
	var tip = d3.tip().attr("class","tip").html(renderTip);
		

      svg.append("g")
      .attr("class", "states")
	  .selectAll("path")
      .data(m).enter()
	  .append("path")
	  .attr("fill",d=>{
		  var q = eqMap[stateMap[d.properties.name]];
		  return hues[scaleLoans(q["Q4_2019"])];
					  })
	  .attr("class",d=>d.properties.name)
	  .attr("d",path)
	  .call(tip)
	  .on('mouseover',tip.show)
	  .on('mouseout',tip.hide);
		
	svg.select(".Alaska").attr("transform",`translate(${width*0.2},${height*0.85}),scale(0.5)`);
	svg.select(".Hawaii").attr("transform",`translate(${width*0.75},${height*0.35})`);
		
		
	

		
		svg.append("text")
		.attr("text-anchor","middle")
		.attr("x",width/2)
		.attr("y",50)
		.attr("font-size","14pt")
		.text("Student Loans");
		
	
		
			
		
	});
	
	
	
	


</script>
</body>
</html>